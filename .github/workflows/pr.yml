name: Build cryptofuzz
on:
  pull_request:
    branches: [ main, master ]
  push:
    branches: [ main, master ]
  release:
    types: [ released ]
  workflow_dispatch:
jobs:
  build:
    name: Build with ${{ matrix.module.name }}
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        module:
          - name: NSS
            build_script: .github/scripts/build-nss.sh
            environment: |
              CXXFLAGS="-I ${GITHUB_WORKSPACE}/dist/public/nss -I ${GITHUB_WORKSPACE}/dist/Debug/include/nspr -DCRYPTOFUZZ_NSS -DCRYPTOFUZZ_NO_OPENSSL"
              echo "LINK_FLAGS=${LINK_FLAGS} -lsqlite3" >> $GITHUB_ENV
              echo "NSS_NSPR_PATH=${GITHUB_WORKSPACE}" >> $GITHUB_ENV

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            cmake \
            gyp \
            libboost-dev \
            libsqlite3-dev \
            mercurial \
            ninja-build \
            python3 \
            python3-pip \
            zlib1g-dev

      - name: Build ${{ matrix.module.name }}
        run: |
          ${{ matrix.module.build_script }}

      - name: Generate repository headers
        run: |
          python3 gen_repository.py

      - name: Setup environment
        run: |
          ${{ matrix.module.environment }}
          echo "CC=clang" >> $GITHUB_ENV
          echo "CXX=clang++" >> $GITHUB_ENV
          echo "CFLAGS=$CFLAGS -fsanitize=address,undefined,fuzzer-no-link -O2 -g" >> $GITHUB_ENV
          echo "CXXFLAGS=$CXXFLAGS -fsanitize=address,undefined,fuzzer-no-link -O2 -g" >> $GITHUB_ENV
          echo "LIBFUZZER_LINK=-fsanitize=fuzzer" >> $GITHUB_ENV

      - name: Build ${{ matrix.module.name }} module
        run: |
          cd modules/$(echo "${{ matrix.module.name }}" | tr '[:upper:]' '[:lower:]')
          make -j$(nproc)

      - name: Build cryptofuzz
        run: |
          make -j$(nproc)

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: cryptofuzz-${{ matrix.module.name }}-${{ github.sha }}
          path: cryptofuzz
          retention-days: 7
